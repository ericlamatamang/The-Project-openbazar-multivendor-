{% extends 'admin_dashboard/base_admin.html' %}
{% block content %}
<div class="container-fluid">
  <div class="row g-3">
      <div class="col-12">
        <div class="stats-grid">
          <div class="stat-card card">
            <div class="label">Total Users</div>
            <div class="value">{{ total_users }}</div>
          </div>
          <div class="stat-card card">
            <div class="label">Total Products</div>
            <div class="value">{{ total_products }}</div>
          </div>
          <div class="stat-card card">
            <div class="label">Total Orders</div>
            <div class="value">{{ total_orders }}</div>
          </div>
          <div class="stat-card card">
            <div class="label">Total Revenue</div>
            <div class="value">Rs {{ total_revenue|floatformat:2 }}</div>
          </div>
        </div>
      </div>
  </div>

  <div class="row g-3 mt-3">
    <div class="col-lg-6">
      <div class="card p-3">
        <h6>Orders (Last 7 days)</h6>
        <canvas id="ordersLast7" height="120"></canvas>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card p-3">
        <h6>Order Status Distribution</h6>
        <canvas id="statusPie" height="120"></canvas>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-3">
    <div class="col-lg-8">
      <div class="card p-3">
        <h6>Quick Actions</h6>
        <div class="d-flex gap-2">
          <a href="{% url 'admin_dashboard:create_user' %}" class="btn btn-primary">Add User</a>
          <a href="{% url 'admin_dashboard:products' %}" class="btn btn-outline-secondary">Manage Products</a>
          <a href="{% url 'admin_dashboard:users' %}" class="btn btn-outline-secondary">Manage Users</a>
        </div>
        <div class="mt-3">
          <small class="text-muted">Pending Vendor Approvals: <span class="badge bg-warning text-dark">{{ pending_vendor_count }}</span></small>
          <small class="text-muted ms-3">Pending Product Approvals: <span class="badge bg-warning text-dark">{{ pending_product_count }}</span></small>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card p-3">
        <h6>Pending Vendors</h6>
        <ul class="list-unstyled mb-0">
          {% for v in pending_vendors %}
            <li class="py-2 border-bottom d-flex justify-content-between align-items-center">
              <div>
                {{ v.user.get_full_name|default:v.user.username }}<br><small class="text-muted">{{ v.user.email }}</small>
              </div>
              <div>
                <form method="post" action="{% url 'admin_dashboard:approve_vendor' v.id %}" style="display:inline">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="approve">
                  <button class="btn btn-sm btn-success">Approve</button>
                </form>
                <form method="post" action="{% url 'admin_dashboard:reject_vendor' v.id %}" style="display:inline">
                  {% csrf_token %}
                  <button class="btn btn-sm btn-outline-danger">Reject</button>
                </form>
              </div>
            </li>
          {% empty %}
            <li>No pending vendors</li>
          {% endfor %}
        </ul>
      </div>
      <div class="card p-3 mt-3">
        <h6>Pending Products</h6>
        <ul class="list-unstyled mb-0">
          {% for p in pending_products %}
            <li class="py-2 border-bottom d-flex justify-content-between align-items-center">
              <div>
                {{ p.name }}<br><small class="text-muted">{% if p.vendor %}{{ p.vendor.user.username }}{% else %}—{% endif %}</small>
              </div>
              <div>
                <form method="post" action="{% url 'admin_dashboard:approve_product' p.id %}" style="display:inline">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="approve">
                  <button class="btn btn-sm btn-success">Approve</button>
                </form>
                <form method="post" action="{% url 'admin_dashboard:approve_product' p.id %}" style="display:inline">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="disable">
                  <button class="btn btn-sm btn-outline-danger">Disable</button>
                </form>
              </div>
            </li>
          {% empty %}
            <li>No pending products</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-3">
    <div class="col-lg-8">
      <div class="card p-3">
        <h6>Recent Orders</h6>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Order</th>
                <th>User</th>
                <th>Product(s)</th>
                <th>Vendor(s)</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for o in recent_orders %}
                <tr>
                  <td>#{{ o.id }}</td>
                  <td>{{ o.user_name }}</td>
                  <td>
                    {% if o.product_list %}
                      {{ o.product_list|join:", " }}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td>
                    {% if o.vendor_list %}
                      {{ o.vendor_list|join:", " }}
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td>Rs {{ o.total_amount|floatformat:2 }}</td>
                  <td>{{ o.status }}</td>
                  <td>
                    <form method="post" action="{% url 'admin_dashboard:change_order_status' o.id %}" class="d-inline">
                      {% csrf_token %}
                      <select name="status" class="form-select form-select-sm d-inline w-auto">
                        <option value="pending" {% if o.status == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="paid" {% if o.status == 'paid' %}selected{% endif %}>Paid</option>
                        <option value="delivered" {% if o.status == 'delivered' %}selected{% endif %}>Delivered</option>
                      </select>
                      <button class="btn btn-sm btn-primary">Update</button>
                    </form>
                    <form method="post" action="{% url 'admin_dashboard:delete_order' o.id %}" style="display:inline">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete order #{{ o.id }}? This cannot be undone.');">Delete</button>
                    </form>
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="7">No recent orders</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card p-3 mb-3">
        <h6>Recent Users</h6>
        <ul class="list-unstyled mb-0">
          {% for u in recent_users %}
            <li class="py-2 border-bottom">{{ u.get_full_name|default:u.username }} <br><small class="text-muted">{{ u.email }}</small></li>
          {% empty %}
            <li>No users</li>
          {% endfor %}
        </ul>
      </div>
      <div class="card p-3">
        <h6>Admin Activity</h6>
        <ul class="list-unstyled mb-0">
          {% for a in activities %}
            <li class="py-2 border-bottom">{{ a.timestamp|date:'Y-m-d H:i' }} — {{ a.user }} — {{ a.action }}</li>
          {% empty %}
            <li>No activity yet</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

{% endblock %}

{% block scripts %}
  <script>
  const ordersLast7 = JSON.parse('{{ chart_orders_last7_json|escapejs }}');
  const statusData = JSON.parse('{{ status_qs_json|escapejs }}');

  // ordersLast7: [{date:'YYYY-MM-DD','orders':N}, ...]
  initOrdersChart('ordersLast7', ordersLast7);
  initStatusPie('statusPie', statusData);
</script>
{% endblock %}
